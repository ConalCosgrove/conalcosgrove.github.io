<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåç</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countries Quiz</title>
</head>
<style>
    #game {
        display: flex;
        flex-direction: column;
        align-items: center;

    }
    #current-flag {
        max-width: 80vw;
    }
    .flag {
        margin-bottom: 50px;
        border: 4px solid black;
    }
    .missed-flag {
        height: 200px;
    }
    #guess-input {
        height: 20px;
        width: 80vw;
        margin-top: 20px;
        font-size: 20px;
    }
    #skipped-country-list {
        display: flex;
        flex-direction: column;
    }
    #skipped-country {
        display: flex;
        flex-direction: row;
        height: 200px;
        justify-content: space-around;
        align-items: center;
        margin: 25px;
        width: 100%;
    }
    .hidden {
        display: none;
    }
    .visible {
        display: block;
    }

</style>
<body>
    <div id="game">
        <input id="guess-input"/>
        <p id="name-text"></p>
        <div id="score-holder">
            <h2 id="score-text"></h2>
            <h2 id="missed-text"></h2>
        </div>
        <img id="current-flag" class="flag"></img>
    
    <h1 id="missed-section-heading" class="hidden">Here's what you missed:</h1>
    <div id="skipped-country-list">
    </div>
    </div>
</body>
<script>
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    const favicon = document.querySelector('[rel=icon]');
    const flagImg = document.getElementById('current-flag');
    const countryInput = document.getElementById('guess-input');
    const countryText = document.getElementById('name-text');
    const scoreText = document.getElementById('score-text');
    const missedText = document.getElementById('missed-text');
    const skippedCountryHolder = document.getElementById('skipped-country-list');
    const whatYouMissedText = document.getElementById('missed-section-heading');

    const skippedCountries = [];
    let currentCountry;
    let score = 0;
    let missed = 0;
    let skipped = false; 

    scoreText.innerText = `Score: ${score}`;
    missedText.innerText = `Missed: ${missed}`;
    
    // from https://dev.to/jorik/country-code-to-flag-emoji-a21
    function getFlagEmoji(countryCode) {
        const codePoints = countryCode
            .toUpperCase()
            .split('')
            .map(char =>  127397 + char.charCodeAt());
        return String.fromCodePoint(...codePoints);
    }

    function setFavicon(countryCode) {
        favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${getFlagEmoji(countryCode)}</text></svg>`;
    }

    async function generateRandomCountryIterator() {
        const request = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca2');
        const countries = await request.json();
        shuffle(countries)
        function* gen() {
            yield* countries.slice(0,10);
        }
        return gen;
    }
    
    generateRandomCountryIterator().then((iter) => {
        const generator = iter();
        currentCountry = generator.next();
        flagImg.src = currentCountry.value.flags.svg;
        setFavicon(currentCountry.value.cca2);
        countryInput.onkeyup = (e) => {

            switch (countryInput.value.toLowerCase().trim()) {
                case 'skip': {
                    skippedCountries.push(currentCountry);
                    countryInput.value = ""
                    countryText.innerText = currentCountry.value.name.common;
                    missedText.innerText = `Missed: ${++missed}`;
                    skipped = true;
                    break;
                }
                case currentCountry.value.name.common.toLowerCase(): {
                    countryText.innerText = ""
                    countryInput.value = ""
                    if (!skipped) {
                        score++;
                        scoreText.innerText = `Score: ${score}`;
                    }
                    skipped = false;
                    currentCountry = generator.next();
                    if (!currentCountry.done) {
                        flagImg.src = currentCountry.value.flags.svg;
                        setFavicon(currentCountry.value.cca2)
                    }
                    break;
                }
                default: {
                    break;
                } 
            }

            if (currentCountry.done) {
                flagImg.src =  'https://www.looper.com/img/gallery/where-is-seinfelds-real-life-cosmo-kramer-today/intro-1671045259.webp'
                whatYouMissedText.className = "visible"
                skippedCountries.map((country) => {
                    const img = document.createElement('img');
                    const text = document.createElement('h2');
                    const div = document.createElement('div');
                    div.id = "skipped-country"
                    img.className = "flag missed-flag"
                    img.src = country.value.flags.svg;
                    text.innerText = country.value.name.common;
                    div.appendChild(img);
                    div.appendChild(text);
                    skippedCountryHolder.appendChild(div);
                });
            }
        };
    });
    


</script>
</html>